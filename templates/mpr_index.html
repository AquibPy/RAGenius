<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Multi-Provider RAG Search</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Markdown Styles */
        .markdown-content h1 { font-size: 1.5em; font-weight: bold; margin: 0.5em 0; }
        .markdown-content h2 { font-size: 1.3em; font-weight: bold; margin: 0.5em 0; }
        .markdown-content h3 { font-size: 1.1em; font-weight: bold; margin: 0.5em 0; }
        .markdown-content p { margin: 0.5em 0; }
        .markdown-content ul, .markdown-content ol { margin: 0.5em 0; padding-left: 1.5em; }
        .markdown-content li { margin: 0.25em 0; }
        .markdown-content code { background: rgba(0,0,0,0.1); padding: 0.1em 0.3em; border-radius: 3px; font-family: 'Courier New', monospace; }
        .markdown-content pre { background: rgba(0,0,0,0.2); padding: 1em; border-radius: 6px; overflow-x: auto; }
        .markdown-content pre code { background: none; padding: 0; }
        .markdown-content strong { font-weight: bold; }
        .markdown-content em { font-style: italic; }
        .markdown-content a { text-decoration: underline; }
        .markdown-content blockquote { border-left: 3px solid rgba(255,255,255,0.3); padding-left: 1em; margin: 0.5em 0; opacity: 0.9; }
        
        .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; }
    </style>
</head>
<body>
    <div id="root"></div>
    {% raw %}
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const uid = () => {
            if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {
                return crypto.randomUUID();
            }
            return `${Date.now()}_${Math.random().toString(36).slice(2,9)}`;
        };

        // Icons
        const Search = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
            </svg>
        );

        const Upload = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
        );

        const FileText = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
            </svg>
        );

        const Database = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
            </svg>
        );

        const Send = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
        );

        const Loader2 = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
            </svg>
        );

        const X = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        );

        const Settings = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6"/>
            </svg>
        );

        const CheckCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        );

        const AlertCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
        );

        const ChevronDown = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="6 9 12 15 18 9"/>
            </svg>
        );

        const ChevronUp = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="18 15 12 9 6 15"/>
            </svg>
        );

        const Sun = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/>
            </svg>
        );

        const Moon = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
        );

        const Cpu = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/>
            </svg>
        );

        const Zap = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </svg>
        );

        // Main Component
        function MultiProviderRAGUI() {
            const [query, setQuery] = useState('');
            const [messages, setMessages] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [mode, setMode] = useState('stream');
            const [topK, setTopK] = useState(5);
            const [summarize, setSummarize] = useState(false);
            
            // Provider selection
            const [embeddingProvider, setEmbeddingProvider] = useState('azure');
            const [llmProvider, setLlmProvider] = useState('azure');
            const [uploadEmbeddingProvider, setUploadEmbeddingProvider] = useState('azure');
            
            const [files, setFiles] = useState([]);
            const [isUploading, setIsUploading] = useState(false);
            const [uploadStatus, setUploadStatus] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [darkMode, setDarkMode] = useState(true);
            const [apiHealth, setApiHealth] = useState(null);
            const [expandedSources, setExpandedSources] = useState({});
            const [activeEngines, setActiveEngines] = useState([]);
            const [providerInfo, setProviderInfo] = useState(null);

            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);
            const API_BASE = window.location.origin;

            useEffect(() => {
                checkHealth();
                fetchActiveEngines();
                fetchProviders();
                const interval = setInterval(() => {
                    checkHealth();
                    fetchActiveEngines();
                    console.log(activeEngines)
                }, 30000);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const checkHealth = async () => {
                try {
                    const res = await fetch(`${API_BASE}/health`);
                    const data = await res.json();
                    setApiHealth(data);
                } catch (err) {
                    setApiHealth({ status: 'error', error: 'Cannot connect to API' });
                }
            };

            const fetchActiveEngines = async () => {
                try {
                    const res = await fetch(`${API_BASE}/rag/engines`);
                    const data = await res.json();
                    setActiveEngines(data.active_engine || []);
                } catch (err) {
                    console.error('Failed to fetch engines:', err);
                }
            };

            const fetchProviders = async () => {
                try {
                    const res = await fetch(`${API_BASE}/rag/providers`);
                    const data = await res.json();
                    setProviderInfo(data);
                } catch (err) {
                    console.error('Failed to fetch providers:', err);
                }
            };

            const handleSubmit = (e) => {
                e?.preventDefault();
                if (!query.trim() || isLoading) return;

                const userMessage = {
                    id: uid(),
                    role: 'user',
                    content: query,
                    timestamp: new Date(),
                    providers: { embedding: embeddingProvider, llm: llmProvider }
                };

                setMessages(prev => [...prev, userMessage]);

                const currentQuery = query;
                setQuery('');
                setIsLoading(true);

                if (mode === 'stream') {
                    handleStreamQuery(currentQuery);
                } else {
                    handleBasicQuery(currentQuery);
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSubmit(e);
                }
            };

            const handleBasicQuery = async (queryText) => {
                try {
                    const res = await fetch(`${API_BASE}/rag/basic`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            query: queryText, 
                            top_k: topK,
                            summarize: summarize,
                            embedding_provider: embeddingProvider,
                            llm_provider: llmProvider
                        })
                    });

                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({ detail: 'Unknown error' }));
                        throw new Error(errorData.detail || 'Query failed');
                    }

                    const data = await res.json();

                    setMessages(prev => [...prev, {
                        id: uid(),
                        role: 'assistant',
                        content: data.answer || 'No answer returned.',
                        sources: data.sources || [],
                        providers: data.providers_used || { embedding: embeddingProvider, llm: llmProvider },
                        timestamp: new Date()
                    }]);
                } catch (err) {
                    setMessages(prev => [...prev, {
                        id: uid(),
                        role: 'error',
                        content: `Error: ${err.message}`,
                        timestamp: new Date()
                    }]);
                } finally {
                    setIsLoading(false);
                    fetchActiveEngines();
                }
            };

            const handleStreamQuery = async (queryText) => {
                const messageId = uid();
                let accumulatedContent = '';
                let buffer = '';
                let detectedProviders = null;

                setMessages(prev => [...prev, {
                    id: messageId,
                    role: 'assistant',
                    content: '',
                    timestamp: new Date(),
                    isStreaming: true,
                    providers: { embedding: embeddingProvider, llm: llmProvider }
                }]);

                try {
                    const res = await fetch(`${API_BASE}/rag/stream`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            query: queryText, 
                            top_k: topK,
                            summarize: summarize,
                            embedding_provider: embeddingProvider,
                            llm_provider: llmProvider
                        })
                    });

                    if (!res.ok) throw new Error(`Stream failed: ${res.statusText}`);
                    if (!res.body) throw new Error('No stream body');

                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const parts = buffer.split('\n');
                        buffer = parts.pop();

                        for (const rawLine of parts) {
                            const line = rawLine.trim();
                            if (!line) continue;

                            if (line.startsWith('data:')) {
                                const data = line.replace(/^data:\s*/g, '').trim();

                                if (data === '[DONE]') {
                                    setMessages(prev =>
                                        prev.map(msg =>
                                            msg.id === messageId
                                                ? { 
                                                    ...msg, 
                                                    content: accumulatedContent.trim(), 
                                                    isStreaming: false,
                                                    providers: detectedProviders || msg.providers
                                                  }
                                                : msg
                                        )
                                    );
                                    setIsLoading(false);
                                    fetchActiveEngines();
                                    return;
                                } else if (data.startsWith('[ERROR]')) {
                                    throw new Error(data.slice(8) || 'Unknown stream error');
                                } else if (data.startsWith('{') && data.includes('"type"')) {
                                    try {
                                        const providerData = JSON.parse(data);
                                        if (providerData.type === 'providers') {
                                            detectedProviders = {
                                                embedding: providerData.embedding,
                                                llm: providerData.llm
                                            };
                                        }
                                    } catch (e) {
                                        accumulatedContent += data + ' ';
                                    }
                                } else if (data.trim()) {
                                    accumulatedContent += data + ' ';
                                    setMessages(prev =>
                                        prev.map(msg =>
                                            msg.id === messageId
                                                ? { ...msg, content: accumulatedContent }
                                                : msg
                                        )
                                    );
                                }
                            }
                        }
                    }

                    if (buffer.trim()) {
                        const lastLine = buffer.trim();
                        if (lastLine.startsWith('data:')) {
                            const data = lastLine.replace(/^data:\s*/g, '');
                            if (data !== '[DONE]' && !data.startsWith('[ERROR]')) {
                                accumulatedContent += data;
                            }
                        }
                    }

                    setMessages(prev =>
                        prev.map(msg =>
                            msg.id === messageId
                                ? { 
                                    ...msg, 
                                    content: accumulatedContent.trim(), 
                                    isStreaming: false,
                                    providers: detectedProviders || msg.providers
                                  }
                                : msg
                        )
                    );
                } catch (err) {
                    setMessages(prev =>
                        prev.map(msg =>
                            msg.id === messageId
                                ? {
                                    ...msg,
                                    role: 'error',
                                    content: `Error: ${err.message}`,
                                    isStreaming: false
                                  }
                                : msg
                        )
                    );
                } finally {
                    setIsLoading(false);
                    fetchActiveEngines();
                }
            };

            const handleFileUpload = async () => {
                if (files.length === 0) return;

                setIsUploading(true);
                setUploadStatus(null);

                const formData = new FormData();
                files.forEach(file => formData.append('files', file));

                try {
                    const res = await fetch(`${API_BASE}/rag/upload?embedding_provider=${uploadEmbeddingProvider}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({ detail: 'Unknown error' }));
                        throw new Error(errorData.detail || 'Upload failed');
                    }
                    
                    const data = await res.json();

                    setUploadStatus({
                        type: 'success',
                        message: data.message || 'Upload successful',
                        details: `Added ${data.new_chunks_added || 0} chunks. Total: ${data.total_chunks_in_db || 0}`,
                        rejectedFiles: data.rejected_files
                    });

                    setFiles([]);
                    checkHealth();
                    fetchActiveEngines();
                } catch (err) {
                    setUploadStatus({
                        type: 'error',
                        message: `Upload failed: ${err.message}`
                    });
                } finally {
                    setIsUploading(false);
                }
            };

            const renderMarkdown = (content) => {
                if (typeof marked !== 'undefined' && marked.parse) {
                    return marked.parse(content);
                }
                return content;
            };

            const toggleSourceExpansion = (msgId) => {
                setExpandedSources(prev => ({
                    ...prev,
                    [msgId]: !prev[msgId]
                }));
            };

            const getProviderBadgeColor = (provider, type) => {
                if (type === 'embedding') {
                    return provider === 'gemini' ? 'bg-purple-500' : 'bg-blue-500';
                } else {
                    return provider === 'groq' ? 'bg-green-500' : 'bg-indigo-500';
                }
            };

            const theme = darkMode ? {
                bg: 'bg-gray-900',
                surface: 'bg-gray-800',
                border: 'border-gray-700',
                text: 'text-gray-100',
                textSecondary: 'text-gray-400',
                hover: 'hover:bg-gray-700',
                input: 'bg-gray-700 border-gray-600 text-gray-100'
            } : {
                bg: 'bg-gray-50',
                surface: 'bg-white',
                border: 'border-gray-200',
                text: 'text-gray-900',
                textSecondary: 'text-gray-600',
                hover: 'hover:bg-gray-100',
                input: 'bg-white border-gray-300 text-gray-900'
            };

            return (
                <div className={`min-h-screen ${theme.bg} ${theme.text} flex flex-col`}>
                    {/* Header */}
                    <header className={`${theme.surface} border-b ${theme.border} sticky top-0 z-10 backdrop-blur-sm bg-opacity-95`}>
                        <div className="container mx-auto px-4 sm:px-6 py-3">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-gradient-to-br from-blue-500 via-purple-600 to-green-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <Database className="w-6 h-6 text-white" />
                                    </div>
                                    <div>
                                        <h1 className="text-lg sm:text-xl font-bold">Multi-Provider RAG</h1>
                                        <p className={`text-xs ${theme.textSecondary} hidden sm:block`}>
                                            Azure • Gemini • Groq
                                        </p>
                                    </div>
                                </div>
                                
                                <div className="flex items-center gap-2 sm:gap-4">
                                    {apiHealth && (
                                        <div className="flex items-center gap-2 text-xs sm:text-sm">
                                            <div className={`w-2 h-2 rounded-full ${
                                                apiHealth.status === 'healthy' ? 'bg-green-500' : 
                                                apiHealth.status === 'initializing' ? 'bg-yellow-500' : 'bg-red-500'
                                            }`} />
                                            <span className={`${theme.textSecondary} hidden sm:inline`}>
                                                {activeEngines.length} engine{activeEngines.length !== 1 ? 's' : ''}
                                            </span>
                                        </div>
                                    )}
                                    
                                    <button
                                        onClick={() => setDarkMode(!darkMode)}
                                        className={`p-2 rounded-lg ${theme.hover} transition-colors`}
                                    >
                                        {darkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
                                    </button>
                                    
                                    <button
                                        onClick={() => setShowSettings(!showSettings)}
                                        className={`p-2 rounded-lg ${theme.hover} transition-colors`}
                                    >
                                        <Settings className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="container mx-auto px-4 sm:px-6 py-4 flex-1 flex flex-col">
                        <div className="grid grid-cols-1 xl:grid-cols-4 gap-4 flex-1">
                            {/* Main Chat Area */}
                            <div className="xl:col-span-3 flex flex-col space-y-4 min-h-0">
                                {/* Settings Panel */}
                                {showSettings && (
                                    <div className={`${theme.surface} rounded-xl p-4 sm:p-6 border ${theme.border} shadow-lg`}>
                                        <h3 className="text-lg font-semibold mb-4">Query Settings</h3>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className={`block text-sm font-medium mb-2 ${theme.textSecondary}`}>
                                                    Query Mode
                                                </label>
                                                <select
                                                    value={mode}
                                                    onChange={(e) => setMode(e.target.value)}
                                                    className={`w-full px-3 py-2 rounded-lg border ${theme.input} focus:outline-none focus:ring-2 focus:ring-blue-500`}
                                                >
                                                    <option value="stream">Streaming (Real-time)</option>
                                                    <option value="basic">Basic (Complete)</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label className={`block text-sm font-medium mb-2 ${theme.textSecondary}`}>
                                                    Top K Results
                                                </label>
                                                <input
                                                    type="number"
                                                    value={topK}
                                                    onChange={(e) => {
                                                        const v = parseInt(e.target.value);
                                                        setTopK(Number.isFinite(v) && v > 0 ? v : 1);
                                                    }}
                                                    min="1"
                                                    max="20"
                                                    className={`w-full px-3 py-2 rounded-lg border ${theme.input} focus:outline-none focus:ring-2 focus:ring-blue-500`}
                                                />
                                            </div>

                                            <div>
                                                <label className={`block text-sm font-medium mb-2 ${theme.textSecondary}`}>
                                                    <Cpu className="w-4 h-4 inline mr-1" />
                                                    Embedding Provider
                                                </label>
                                                <select
                                                    value={embeddingProvider}
                                                    onChange={(e) => setEmbeddingProvider(e.target.value)}
                                                    className={`w-full px-3 py-2 rounded-lg border ${theme.input} focus:outline-none focus:ring-2 focus:ring-purple-500`}
                                                >
                                                    <option value="azure">Azure OpenAI</option>
                                                    <option value="gemini">Google Gemini</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label className={`block text-sm font-medium mb-2 ${theme.textSecondary}`}>
                                                    <Zap className="w-4 h-4 inline mr-1" />
                                                    LLM Provider
                                                </label>
                                                <select
                                                    value={llmProvider}
                                                    onChange={(e) => setLlmProvider(e.target.value)}
                                                    className={`w-full px-3 py-2 rounded-lg border ${theme.input} focus:outline-none focus:ring-2 focus:ring-green-500`}
                                                >
                                                    <option value="azure">Azure OpenAI</option>
                                                    <option value="groq">Groq (Fast)</option>
                                                </select>
                                            </div>

                                            <div className="md:col-span-2">
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={summarize}
                                                        onChange={(e) => setSummarize(e.target.checked)}
                                                        className="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                                                    />
                                                    <span className="text-sm font-medium">Include summary</span>
                                                </label>
                                            </div>
                                        </div>

                                        <div className="mt-4 p-3 bg-blue-500 bg-opacity-10 border border-blue-500 rounded-lg">
                                            <p className="text-xs font-medium">
                                                Current: <span className={`badge ${getProviderBadgeColor(embeddingProvider, 'embedding')} text-white ml-1`}>
                                                    {embeddingProvider.toUpperCase()}
                                                </span>
                                                {' + '}
                                                <span className={`badge ${getProviderBadgeColor(llmProvider, 'llm')} text-white`}>
                                                    {llmProvider.toUpperCase()}
                                                </span>
                                            </p>
                                        </div>
                                    </div>
                                )}

                                {/* Messages */}
                                <div className={`${theme.surface} rounded-xl border ${theme.border} shadow-lg flex-1 flex flex-col min-h-0`}>
                                    <div className="flex-1 overflow-y-auto p-4 sm:p-6 space-y-4 scrollbar-hide">
                                        {messages.length === 0 ? (
                                            <div className="h-full flex items-center justify-center">
                                                <div className="text-center p-4">
                                                    <Search className={`w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-4 ${theme.textSecondary}`} />
                                                    <h3 className="text-lg sm:text-xl font-semibold mb-2">Ready to Search</h3>
                                                    <p className={`text-sm ${theme.textSecondary} mb-3`}>
                                                        Ask questions about your documents
                                                    </p>
                                                    <div className="flex flex-wrap justify-center gap-2 text-xs">
                                                        <span className="badge bg-purple-500 text-white">Gemini Embed</span>
                                                        <span className="badge bg-blue-500 text-white">Azure Embed</span>
                                                        <span className="badge bg-indigo-500 text-white">Azure LLM</span>
                                                        <span className="badge bg-green-500 text-white">Groq LLM</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : (
                                            messages.map((msg) => (
                                                <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                    <div className={`max-w-full sm:max-w-3xl ${
                                                        msg.role === 'user' 
                                                            ? 'bg-blue-600 text-white' 
                                                            : msg.role === 'error'
                                                            ? 'bg-red-500 text-white'
                                                            : darkMode ? 'bg-gray-700' : 'bg-gray-100'
                                                    } rounded-2xl px-3 sm:px-4 py-3 shadow-md`}>
                                                        
                                                        {/* Provider badges */}
                                                        {msg.providers && (
                                                            <div className="flex flex-wrap gap-1 mb-2 text-xs">
                                                                <span className={`badge ${getProviderBadgeColor(msg.providers.embedding, 'embedding')} text-white`}>
                                                                    {msg.providers.embedding?.toUpperCase()}
                                                                </span>
                                                                <span className={`badge ${getProviderBadgeColor(msg.providers.llm, 'llm')} text-white`}>
                                                                    {msg.providers.llm?.toUpperCase()}
                                                                </span>
                                                            </div>
                                                        )}

                                                        {msg.role === 'user' ? (
                                                            <div className="whitespace-pre-wrap break-words text-sm sm:text-base">{msg.content}</div>
                                                        ) : (
                                                            <div 
                                                                className="markdown-content text-sm sm:text-base"
                                                                dangerouslySetInnerHTML={{ __html: renderMarkdown(msg.content) }}
                                                            />
                                                        )}
                                                        
                                                        {msg.isStreaming && (
                                                            <div className="flex items-center gap-2 mt-2 text-sm opacity-70">
                                                                <Loader2 className="w-4 h-4 animate-spin" />
                                                                <span>Generating...</span>
                                                            </div>
                                                        )}
                                                        
                                                        {msg.sources && msg.sources.length > 0 && (
                                                            <div className="mt-3 pt-3 border-t border-opacity-20 border-white">
                                                                <button
                                                                    onClick={() => toggleSourceExpansion(msg.id)}
                                                                    className="flex items-center gap-2 text-sm font-medium hover:opacity-80 transition-opacity"
                                                                >
                                                                    <FileText className="w-4 h-4" />
                                                                    {msg.sources.flat().filter(s => s?.source_file).length} Source{msg.sources.flat().filter(s => s?.source_file).length !== 1 ? 's' : ''}
                                                                    {expandedSources[msg.id] ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
                                                                </button>
                                                                
                                                                {expandedSources[msg.id] && (
                                                                    <div className="mt-2 space-y-2">
                                                                        {msg.sources.flat().filter(s => s?.source_file).map((source, idx) => (
                                                                            <div key={idx} className="text-xs p-3 bg-black bg-opacity-20 rounded space-y-1">
                                                                                {source.source_file && (
                                                                                    <div className="flex justify-between">
                                                                                        <strong>File:</strong> 
                                                                                        <span className="text-right ml-2">{source.source_file}</span>
                                                                                    </div>
                                                                                )}
                                                                                {source.file_type && (
                                                                                    <div className="flex justify-between">
                                                                                        <strong>Type:</strong> 
                                                                                        <span className="uppercase">{source.file_type}</span>
                                                                                    </div>
                                                                                )}
                                                                                {source.page && (
                                                                                    <div className="flex justify-between">
                                                                                        <strong>Page:</strong> 
                                                                                        <span>{source.page}</span>
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                        
                                                        <div className="text-xs opacity-60 mt-2">
                                                            {msg.timestamp instanceof Date ? msg.timestamp.toLocaleTimeString() : (new Date(msg.timestamp)).toLocaleTimeString()}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                        <div ref={messagesEndRef} />
                                    </div>
                                    
                                    {/* Input Area */}
                                    <div className={`border-t ${theme.border} p-3 sm:p-4`}>
                                        <div className="flex gap-2 sm:gap-3">
                                            <input
                                                type="text"
                                                value={query}
                                                onChange={(e) => setQuery(e.target.value)}
                                                onKeyDown={handleKeyDown}
                                                placeholder="Ask a question about your documents..."
                                                disabled={isLoading}
                                                className={`flex-1 px-3 sm:px-4 py-2 sm:py-3 rounded-lg border ${theme.input} focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 text-sm sm:text-base`}
                                            />
                                            <button
                                                onClick={handleSubmit}
                                                disabled={isLoading || !query.trim()}
                                                className="px-4 sm:px-6 py-2 sm:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2"
                                            >
                                                {isLoading ? (
                                                    <Loader2 className="w-5 h-5 animate-spin" />
                                                ) : (
                                                    <Send className="w-5 h-5" />
                                                )}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Sidebar */}
                            <div className="xl:col-span-1 space-y-4">
                                {/* Upload Panel */}
                                <div className={`${theme.surface} rounded-xl p-4 sm:p-6 border ${theme.border} shadow-lg`}>
                                    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <Upload className="w-5 h-5" />
                                        Upload Documents
                                    </h3>

                                    <div className="mb-3">
                                        <label className={`block text-sm font-medium mb-2 ${theme.textSecondary}`}>
                                            Embedding Provider
                                        </label>
                                        <select
                                            value={uploadEmbeddingProvider}
                                            onChange={(e) => setUploadEmbeddingProvider(e.target.value)}
                                            className={`w-full px-3 py-2 rounded-lg border ${theme.input} focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm`}
                                        >
                                            <option value="azure">Azure OpenAI</option>
                                            <option value="gemini">Google Gemini</option>
                                        </select>
                                        <p className="text-xs mt-1 opacity-70">
                                            Documents will be embedded with {uploadEmbeddingProvider.toUpperCase()}
                                        </p>
                                    </div>
                                    
                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        multiple
                                        onChange={(e) => setFiles(Array.from(e.target.files))}
                                        className="hidden"
                                        accept=".pdf,.json,.xlsx,.xls,.txt,.doc,.docx,.csv"
                                    />
                                    
                                    <button
                                        onClick={() => fileInputRef.current?.click()}
                                        className={`w-full p-4 border-2 border-dashed ${theme.border} rounded-lg ${theme.hover} transition-colors text-center`}
                                    >
                                        <Upload className={`w-8 h-8 mx-auto mb-2 ${theme.textSecondary}`} />
                                        <p className="text-sm font-medium">Click to upload files</p>
                                        <p className={`text-xs ${theme.textSecondary} mt-1`}>
                                            PDF, JSON, Excel, Text, Word, CSV
                                        </p>
                                    </button>
                                    
                                    {files.length > 0 && (
                                        <div className="mt-4 space-y-2">
                                            {files.map((file, idx) => (
                                                <div key={idx} className={`flex items-center justify-between p-2 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded`}>
                                                    <div className="flex items-center gap-2 flex-1 min-w-0">
                                                        <FileText className="w-4 h-4 flex-shrink-0" />
                                                        <span className="text-sm truncate">{file.name}</span>
                                                    </div>
                                                    <button
                                                        onClick={() => setFiles(files.filter((_, i) => i !== idx))}
                                                        className="p-1 hover:bg-red-500 hover:text-white rounded transition-colors"
                                                    >
                                                        <X className="w-4 h-4" />
                                                    </button>
                                                </div>
                                            ))}
                                            
                                            <button
                                                onClick={handleFileUpload}
                                                disabled={isUploading}
                                                className="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2 text-sm"
                                            >
                                                {isUploading ? (
                                                    <>
                                                        <Loader2 className="w-4 h-4 animate-spin" />
                                                        Uploading...
                                                    </>
                                                ) : (
                                                    <>
                                                        <Upload className="w-4 h-4" />
                                                        Upload {files.length} file{files.length > 1 ? 's' : ''}
                                                    </>
                                                )}
                                            </button>
                                        </div>
                                    )}
                                    
                                    {uploadStatus && (
                                        <div className={`mt-4 p-3 rounded-lg ${
                                            uploadStatus.type === 'success' ? 'bg-green-500 bg-opacity-20' : 'bg-red-500 bg-opacity-20'
                                        } border ${
                                            uploadStatus.type === 'success' ? 'border-green-500' : 'border-red-500'
                                        }`}>
                                            <div className="flex items-start gap-2">
                                                {uploadStatus.type === 'success' ? (
                                                    <CheckCircle className="w-5 h-5 text-green-500 flex-shrink-0" />
                                                ) : (
                                                    <AlertCircle className="w-5 h-5 text-red-500 flex-shrink-0" />
                                                )}
                                                <div>
                                                    <p className="text-sm font-medium">{uploadStatus.message}</p>
                                                    {uploadStatus.details && (
                                                        <p className="text-xs mt-1 opacity-80">{uploadStatus.details}</p>
                                                    )}
                                                    {uploadStatus.rejectedFiles && uploadStatus.rejectedFiles.length > 0 && (
                                                        <div className="mt-2">
                                                            <p className="text-xs font-medium">Rejected files:</p>
                                                            {uploadStatus.rejectedFiles.map((rf, idx) => (
                                                                <p key={idx} className="text-xs opacity-80">
                                                                    • {rf.filename}: {rf.reason}
                                                                </p>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                {/* Active Engines Panel */}
                                <div className={`${theme.surface} rounded-xl p-4 sm:p-6 border ${theme.border} shadow-lg`}>
                                    <h3 className="text-lg font-semibold mb-4">Active Engines</h3>
                                    <div className="space-y-2">
                                        {activeEngines.length === 0 ? (
                                            <p className={`text-sm ${theme.textSecondary}`}>No engines active</p>
                                        ) : (
                                            activeEngines.map((engine, idx) => (
                                                <div key={idx} className={`p-3 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg`}>
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div className="flex items-center gap-2">
                                                            <span className={`badge ${getProviderBadgeColor(engine.embedding_provider, 'embedding')} text-white text-xs`}>
                                                                {engine.embedding_provider.toUpperCase()}
                                                            </span>
                                                            <span className={`badge ${getProviderBadgeColor(engine.llm_provider, 'llm')} text-white text-xs`}>
                                                                {engine.llm_provider.toUpperCase()}
                                                            </span>
                                                        </div>
                                                        {engine.is_default && (
                                                            <span className="badge bg-yellow-500 text-white text-xs">
                                                                Default
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="text-xs opacity-70">
                                                        {engine.vectorstore_count} chunks
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>

                                {/* System Info Panel */}
                                <div className={`${theme.surface} rounded-xl p-4 sm:p-6 border ${theme.border} shadow-lg`}>
                                    <h3 className="text-lg font-semibold mb-4">System Info</h3>
                                    <div className="space-y-3 text-sm">
                                        <div className="flex justify-between items-center">
                                            <span className={theme.textSecondary}>Status</span>
                                            <span className={`font-medium ${
                                                apiHealth?.status === 'healthy' ? 'text-green-500' : 
                                                apiHealth?.status === 'initializing' ? 'text-yellow-500' : 'text-red-500'
                                            }`}>
                                                {apiHealth?.status || 'Unknown'}
                                            </span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className={theme.textSecondary}>Engines</span>
                                            <span className="font-medium">{activeEngines.length}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className={theme.textSecondary}>Mode</span>
                                            <span className="font-medium capitalize">{mode}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className={theme.textSecondary}>Top K</span>
                                            <span className="font-medium">{topK}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<MultiProviderRAGUI />, document.getElementById('root'));
    </script>
    {% endraw %}
</body>
</html>